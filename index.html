<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚類分析與可視化 by c55Math4833</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.1/plotly.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; color: #333; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .left-panel { flex: 1; min-width: 300px; }
        .right-panel { flex: 2; min-width: 600px; }
        .box { background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; }
        h1, h3 { margin-top: 0; color: #2c3e50; }
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .success-message { color: #2980b9; font-weight: bold; }
        .error-message { color: #e74c3c; font-weight: bold; }
        select, input { width: 100%; padding: 8px 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        #plotArea { width: 100%; height: 80vh; }
        .stats-box { margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .checkbox-group { display: flex; gap: 20px; margin-bottom: 10px; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; font-weight: normal; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; }
        .loading-content { text-align: center; color: white; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        #progressText { margin-top: 10px; font-weight: bold; }
        #progressBarContainer { width: 200px; height: 10px; background: #ddd; border-radius: 5px; margin: 10px auto; }
        #progressBar { width: 0%; height: 100%; background: #3498db; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>聚類分析與可視化 by c55Math4833</h1>
    <div class="container">
        <div class="left-panel">
            <div class="box">
                <h3>文件上傳區</h3>
                <div class="form-group">
                    <label for="fileInput">選擇 CSV 文件 (UTF-8 或 Big5 編碼)</label>
                    <input type="file" id="fileInput" accept=".csv">
                </div>
                <button id="nextButton">下一步</button>
                <div id="uploadMessage" class="form-group"></div>
            </div>
            <div class="box">
                <h3>參數設定區</h3>
                <div class="form-group">
                    <label for="algorithmDropdown">選擇聚類算法</label>
                    <select id="algorithmDropdown" disabled>
                        <option value="kmeans">KMeans (K 平均算法)</option>
                        <option value="dbscan">DBSCAN</option>
                        <option value="hierarchical">Hierarchical (層次聚類法)</option>
                        <option value="gmm">Gaussian Mixture (高斯混合模型)</option>
                    </select>
                </div>
                <div class="form-group"><label for="idDropdown">選擇 ID 欄位</label><select id="idDropdown" disabled></select></div>
                <div class="form-group"><label for="x1Dropdown">選擇 X 欄位 (數值, 必選)</label><select id="x1Dropdown" disabled></select></div>
                <div class="form-group"><label for="x2Dropdown">選擇 Y 欄位 (數值, 必選)</label><select id="x2Dropdown" disabled></select></div>
                <div class="form-group"><label for="x3Dropdown">選擇 Z 欄位 (數值, 可選)</label><select id="x3Dropdown" disabled><option value="none">無 (2D 可視化)</option></select></div>
                <div class="form-group" id="clusterNumGroup"><label for="clusterNumInput">聚類組數 (0 為預設)</label><input type="number" id="clusterNumInput" value="0" min="0" step="1" disabled></div>
                <div class="form-group"><label for="preprocessingDropdown">數據預處理方式</label><select id="preprocessingDropdown" disabled><option value="none" selected>不經處理 (None)</option><option value="standardize">標準化 (Standardize)</option></select></div>
                <div class="checkbox-group">
                    <label class="checkbox-label"><input type="checkbox" id="showCentersCheckbox" checked> 顯示聚類中心</label>
                    <label class="checkbox-label" id="boundaryCheckboxGroup"><input type="checkbox" id="showBoundaryCheckbox" checked> 顯示聚類邊界</label>
                </div>
                <button id="calculateButton" disabled>開始計算</button>
            </div>
        </div>
        <div class="right-panel">
            <div class="box">
                <h3>聚類結果可視化</h3>
                <div id="plotArea"></div>
                <div id="resultInfo" class="stats-box"></div>
            </div>
        </div>
    </div>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="progressText">Loading 0%</div>
            <div id="progressBarContainer"><div id="progressBar"></div></div>
        </div>
    </div>
    <script>
    let pyodide=null, csvData=null, columns=[], numericColumns=[], clusterResult=null, idField=null, featureMatrix=null;
    const fileInput=document.getElementById('fileInput'), nextButton=document.getElementById('nextButton'), uploadMessage=document.getElementById('uploadMessage');
    const algorithmDropdown=document.getElementById('algorithmDropdown'), idDropdown=document.getElementById('idDropdown');
    const x1Dropdown=document.getElementById('x1Dropdown'), x2Dropdown=document.getElementById('x2Dropdown'), x3Dropdown=document.getElementById('x3Dropdown');
    const clusterNumInput=document.getElementById('clusterNumInput'), preprocessingDropdown=document.getElementById('preprocessingDropdown');
    const calculateButton=document.getElementById('calculateButton');
    const showCentersCheckbox=document.getElementById('showCentersCheckbox'), showBoundaryCheckbox=document.getElementById('showBoundaryCheckbox');
    const boundaryCheckboxGroup=document.getElementById('boundaryCheckboxGroup');
    const plotArea=document.getElementById('plotArea'), resultInfo=document.getElementById('resultInfo'), loadingOverlay=document.getElementById('loadingOverlay');

    nextButton.addEventListener('click',handleFileUpload);
    calculateButton.addEventListener('click',performClustering);
    showCentersCheckbox.addEventListener('change',renderPlot);
    showBoundaryCheckbox.addEventListener('change',renderPlot);
    algorithmDropdown.addEventListener('change',updateParamVisibility);
    x3Dropdown.addEventListener('change',updateParamVisibility);
    [idDropdown,x1Dropdown,x2Dropdown,x3Dropdown].forEach(sel=>sel.addEventListener('change',enforceUniqueSelection));

    function showLoading(flag){loadingOverlay.style.visibility=flag?'visible':'hidden';}
    function setProgress(pct,text){document.getElementById('progressBar').style.width=pct+'%';document.getElementById('progressText').textContent=text;}

    async function initPyodide(){
        showLoading(true);setProgress(0,'載入 Pyodide...');
        pyodide=await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.27.5/full/',onProgress:(l,t)=>setProgress(Math.round((l/t)*100),`載入 Pyodide ${Math.round((l/t)*100)}%`)});
        setProgress(60,'載入 Python 套件...');await pyodide.loadPackage(['numpy','pandas','micropip']);
        setProgress(85,'安裝 scikit-learn...');await pyodide.runPythonAsync(`import micropip\nawait micropip.install('scikit-learn')`);
        setProgress(95,'初始化分析函數...');await pyodide.runPythonAsync(`
from sklearn.cluster import KMeans,DBSCAN,AgglomerativeClustering
from sklearn.mixture import GaussianMixture
from sklearn.decomposition import PCA
import numpy as np,pandas as pd

def cluster_analysis(data,features,algorithm,n_clusters,preprocessing):
    df=pd.DataFrame(data,columns=features)
    X_orig=df.values
    if preprocessing=='standardize':
        from sklearn.preprocessing import StandardScaler
        X_proc=StandardScaler().fit_transform(X_orig)
    else:
        X_proc=X_orig
    X=X_proc
    if algorithm=='kmeans' and n_clusters==0:
        pca_all=PCA().fit(X)
        cumsum=np.cumsum(pca_all.explained_variance_ratio_)
        n_clusters=int(np.searchsorted(cumsum,0.9)+1)
    elif n_clusters==0:
        n_clusters=3
    model={'kmeans':KMeans(n_clusters=n_clusters,n_init=10,random_state=42),
           'dbscan':DBSCAN(),
           'hierarchical':AgglomerativeClustering(n_clusters=n_clusters),
           'gmm':GaussianMixture(n_components=n_clusters,random_state=42)}[algorithm]
    labels=model.fit_predict(X)
    if hasattr(model,'cluster_centers_'):
        centers=model.cluster_centers_
    elif hasattr(model,'means_'):
        centers=model.means_
    else:
        unique=np.unique(labels)
        centers=np.vstack([X[labels==lab].mean(axis=0) for lab in unique])
    total_ss=np.sum((X-X.mean(axis=0))**2)
    if centers.size>0:
        sse=0
        for idx,lab in enumerate(np.unique(labels)):
            sse+=np.sum((X[labels==lab]-centers[idx])**2)
        var_ratio=1-sse/total_ss
    else:
        var_ratio=0.0
    unique,counts=np.unique(labels,return_counts=True)
    stats={int(ui):int(ci) for ui,ci in zip(unique,counts)}
    return {'labels':labels.tolist(),'centers':centers.tolist(),'explained_variance':float(var_ratio),'stats':stats,'scaled_data':X.tolist()}
`);
        showLoading(false);
    }
    initPyodide();

    async function handleFileUpload(){
        const file=fileInput.files[0];if(!file){showError('請選擇文件');return;}if(!file.name.toLowerCase().endsWith('.csv')){showError('請選擇 CSV 文件');return;}
        showLoading(true);
        const buf=await file.arrayBuffer();let text;
        try{text=new TextDecoder('utf-8',{fatal:true}).decode(buf);}catch{text=new TextDecoder('big5').decode(buf);}
        Papa.parse(text,{header:true,dynamicTyping:false,skipEmptyLines:true,complete:results=>processCsv(results),error:err=>{showError(`CSV 解析錯誤: ${err}`);showLoading(false);}});
    }

    function processCsv(results){
        try{
            let data=results.data;const initial=data.length;
            data.forEach(r=>{for(const k in r){let v=r[k];if(typeof v==='string'){const s=v.trim();if(s==='-')r[k]=0;else if(/^[0-9,]+(\.[0-9]+)?$/.test(s))r[k]=parseFloat(s.replace(/,/g,''));}}});
            data=data.filter(r=>!Object.values(r).some(v=>v===null||v===undefined||v===''));const dropped=initial-data.length;
            if(!data.length){showError('資料清理後無資料');showLoading(false);return;}
            csvData=data;columns=results.meta.fields;numericColumns=columns.filter(c=>typeof data.find(r=>r[c]!=null)[c]==='number');
            updateDropdowns();showSuccess(`成功載入 ${columns.length} 個欄位，共 ${data.length} 筆 (刪除 ${dropped} 筆)`);enableControls();
        }catch(err){showError(err.message);}finally{showLoading(false);}    }

    function updateDropdowns(){
        [idDropdown,x1Dropdown,x2Dropdown].forEach(d=>d.innerHTML='');
        x3Dropdown.innerHTML='<option value="none">無</option>';
        columns.forEach(c=>idDropdown.append(new Option(c,c)));
        numericColumns.forEach(c=>{x1Dropdown.append(new Option(c,c));x2Dropdown.append(new Option(c,c));x3Dropdown.append(new Option(c,c));});
    }

    function enableControls(){
        [algorithmDropdown,idDropdown,x1Dropdown,x2Dropdown,x3Dropdown,clusterNumInput,preprocessingDropdown,calculateButton]
            .forEach(el=>el.disabled=false);
        updateParamVisibility();
    }

    function enforceUniqueSelection(){
        const sels=[idDropdown,x1Dropdown,x2Dropdown,x3Dropdown];
        const vals=sels.map(s=>s.value).filter(v=>v&&v!=='none');
        sels.forEach(s=>Array.from(s.options).forEach(o=>{o.disabled=false; if(o.value&&o.value!==s.value&&vals.includes(o.value))o.disabled=true;}));
    }

    function updateParamVisibility(){
        const alg=algorithmDropdown.value;
        document.getElementById('clusterNumGroup').style.display=alg==='dbscan'?'none':'';
        showCentersCheckbox.parentElement.style.display=alg==='dbscan'?'none':'';
        const is3D=x3Dropdown.value!=='none';
        boundaryCheckboxGroup.style.display=is3D?'none':'';
    }

    function convexHull(points){
        points=points.slice().sort((a,b)=>a[0]===b[0]?a[1]-b[1]:a[0]-b[0]);
        const cross=(o,a,b)=>(a[0]-o[0])*(b[1]-o[1])-(a[1]-o[1])*(b[0]-o[0]);
        let lower=[],upper=[];
        for(let p of points){while(lower.length>=2&&cross(lower[lower.length-2],lower[lower.length-1],p)<=0)lower.pop();lower.push(p);}        
        for(let i=points.length-1;i>=0;i--){let p=points[i];while(upper.length>=2&&cross(upper[upper.length-2],upper[upper.length-1],p)<=0)upper.pop();upper.push(p);}        
        lower.pop();upper.pop();return lower.concat(upper);
    }

    async function performClustering(){
        idField=idDropdown.value;
        const alg=algorithmDropdown.value;
        const x1=x1Dropdown.value, x2=x2Dropdown.value, x3=x3Dropdown.value;
        const n=parseInt(clusterNumInput.value), prep=preprocessingDropdown.value;
        if(!idField||!x1||!x2){showError('請選擇 ID, X, Y 欄位');return;}
        showLoading(true);
        const features=[x1,x2]; if(x3!=='none') features.push(x3);
        const code=`import json
res=cluster_analysis(${JSON.stringify(csvData.map(r=>features.map(f=>r[f])))},${JSON.stringify(features)},'${alg}',${n},'${prep}')
json.dumps(res)`;
        const resJson=await pyodide.runPythonAsync(code);
        clusterResult=JSON.parse(resJson);
        featureMatrix=clusterResult.scaled_data;
        renderPlot(); updateInfo(); showLoading(false);
    }

    function renderPlot(){
        if(!clusterResult) return;
        const labels=clusterResult.labels, centers=clusterResult.centers;
        const is3D=x3Dropdown.value!=='none';
        const unique=Array.from(new Set(labels)).sort((a,b)=>a-b);
        const cs=['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
        const colMap={}; unique.forEach((l,i)=>colMap[l]=cs[i%cs.length]);
        const traces=[];
        unique.forEach(lab=>{
            const pts=labels.map((v,i)=>v===lab?featureMatrix[i]:null).filter(x=>x);
            const xs=pts.map(p=>p[0]), ys=pts.map(p=>p[1]);
            const zs=is3D?pts.map(p=>p[2]):null;
            const texts=labels.map((v,i)=>v===lab?csvData[i][idField]:null).filter(x=>x);
            traces.push({type:is3D?'scatter3d':'scatter',mode:'markers',name:`群 ${lab}`,x:xs,y:ys, ...(is3D?{z:zs}:{}),text:texts,hovertemplate:is3D?'ID:%{text}<br>X1:%{x}<br>X2:%{y}<br>X3:%{z}<extra></extra>':'ID:%{text}<br>X1:%{x}<br>X2:%{y}<extra></extra>',marker:{size:6,color:colMap[lab]}});
        });
        if(showCentersCheckbox.checked) centers.forEach((c,i)=>{
            const lab=unique[i];
            traces.push({type:is3D?'scatter3d':'scatter',mode:'markers',name:`中心 ${lab}`,x:[c[0]],y:[c[1]],...(is3D?{z:[c[2]||0]}:{}),marker:{symbol:'cross',size:12,color:colMap[lab]}});
        });
        if(showBoundaryCheckbox.checked && !is3D) unique.forEach(lab=>{
            const pts=labels.map((v,i)=>v===lab?featureMatrix[i]:null).filter(x=>x);
            if(pts.length>=3){
                let hull=convexHull(pts.map(p=>[p[0],p[1]])); hull.push(hull[0]);
                traces.push({x:hull.map(p=>p[0]),y:hull.map(p=>p[1]),mode:'lines',name:`邊界 ${lab}`,line:{dash:'dash',width:2,color:colMap[lab]}});
            }
        });
        // 3D 限制最大解析度
        let layout={margin:{t:0},autosize:!is3D};
        if(is3D){
            const maxW=Math.min(plotArea.clientWidth,800);
            const maxH=Math.min(window.innerHeight*0.7,600);
            layout.width=maxW; layout.height=maxH;
        }
        Plotly.newPlot(plotArea,traces,layout,{responsive:true});
    }

    function updateInfo(){
        const info=clusterResult;
        const total=Object.values(info.stats).reduce((a,b)=>a+b,0);
        let statsHtml='';
        Object.entries(info.stats).sort((a,b)=>a[0]-b[0]).forEach(([lab,count])=>{
            const pct=(count/total*100).toFixed(2);
            statsHtml += `群 ${lab}: ${count} (${pct}%)<br>`;
        });
        resultInfo.innerHTML=`解釋方差：${(info.explained_variance*100).toFixed(2)}%<br>${statsHtml}`;
    }

    function showError(msg){ uploadMessage.innerHTML=`<div class="error-message">${msg}</div>`; }
    function showSuccess(msg){ uploadMessage.innerHTML=`<div class="success-message">${msg}</div>`; }
    </script>
</body>
</html>